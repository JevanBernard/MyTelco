<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTelco - Smart AI Provider</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon/favicon.ico">
    <link rel="icon" sizes="32x32" href="assets/img/favicon/favicon-32x32.png">
    <link rel="icon" sizes="16x16" href="assets/img/favicon/favicon-16x16.png">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/login.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KOMPONEN (Navbar & Footer) -->
    <script src="assets/js/components.js" defer></script>

    <!-- FOR SPA PAGE CONNECT SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

</head>
<body>

    <!-- WADAH DINAMIS (Konten akan berubah di sini) -->
    <div id="app"></div>

    <!-- SCRIPT ROUTER SPA -->
    <script type="module">
        import Login from './assets/js/login-page.js';
        import Register from './assets/js/register-page.js';
        
        // --- DEFINISI COMPONENT HOME ---
        class Home {
            async render() {
                return `
                    <my-navbar></my-navbar>
                    <main>
                        <!-- HERO SECTION -->
                        <section id="home" class="hero-section">
                            <div class="hero-content">
                                <div class="badge-ai">âš¡ Smart Telco AI</div>
                                <h2>Paket Internet <br><span class="highlight">Spesial Untukmu</span></h2>
                                <p>Sudah punya ID Pelanggan? Masuk sekarang untuk melihat paket rahasia yang dirancang khusus oleh AI sesuai kebiasaanmu.</p>
                                <div class="ai-demo-box" id="ml-demo">
                                    <a href="#login" class="btn-primary">Cek Rekomendasi Saya <img src="assets/img/icon/arrow-up.svg" style="width: 20px; transform: rotate(90deg);" alt="Arrow"></a>
                                    <a href="#packages" class="btn-secondary">Lihat Katalog Umum</a>
                                </div>
                                <div class="stats-section" id="statsSection">
                                    <div class="stat-item"><strong class="stat-number">8</strong><span class="stat-label">Kategori Target</span></div>
                                    <div class="stat-item"><strong class="stat-number">90%</strong><span class="stat-label">Akurasi Prediksi</span></div>
                                    <div class="stat-item"><strong class="stat-number">24/7</strong><span class="stat-label">Analisis Kilat</span></div>
                                </div>
                            </div>
                            <div class="hero-image"><img src="assets/img/hero-illustration.png" alt="Ilustrasi AI Telco"></div>
                        </section>

                        <!-- PROMO BANNER -->
                        <section class="promo-banner">
                            <div class="scrolling-wrapper">
                                <div class="running-text">PERSONALIZED CONNECTIVITY</div>
                                <div class="running-text">PERSONALIZED CONNECTIVITY</div>
                            </div>
                            <div class="promo-description">Nikmati paket seluler yang disesuaikan dengan gaya hidup digital Anda. Didukung oleh AI canggih untuk mencegah kelelahan promosi.</div>
                        </section>

                        <!-- PACKAGES SECTION (TARGET LOGIC KITA) -->
                        <section class="popular-packages" id="paket">
                            <div class="header-section">
                                <div class="header-smart"><img src="./assets/img/icon/thunder.svg" alt="icon"><b class="smart-telco-ai">Pilihan Terbaik</b></div>
                                <h1 class="title-section">Paket <span class="highlight">Populer</span></h1>
                                <p class="subtitle-section">Dipilih oleh jutaan pengguna MyTelco. Hemat, Cepat, dan Anti Lelet.</p>
                            </div>

                            <!-- CONTAINER DINAMIS (ID INI YANG DICARI JS) -->
                            <div class="packages-grid" id="popularPackagesContainer">
                                <div style="grid-column: 1/-1; text-align: center; color: #888;">Memuat paket terbaik...</div>
                            </div>

                            <div class="center-button"><a href="product.html" class="btn-secondary">Lihat Semua Paket</a></div>
                        </section>

                        <!-- FAQ SECTION -->
                        <section id="faq" class="faq-section">
                            <div class="faq-content">
                                <div class="faq-left">
                                    <h2>Bantuan & FAQ</h2>
                                    <p>Temukan jawaban seputar layanan rekomendasi pintar kami.</p>
                                    <a href="#" class="btn-help-center"><img src="assets/img/icon/help-circle.svg" alt="Help"> Pusat Bantuan Lengkap</a>
                                </div>
                                <div class="faq-list faq-right">
                                    <details open><summary>Mengapa saya mendapatkan rekomendasi paket? <img src="assets/img/icon/chevron-down.svg" class="faq-toggle-icon"></summary><div class="faq-answer">Kami memiliki sistem AI yang mendeteksi penggunaan data Anda.</div></details>
                                    <details><summary>Apa itu fitur 'Jaga Pulsa'? <img src="assets/img/icon/chevron-down.svg" class="faq-toggle-icon"></summary><div class="faq-answer">Fitur ini mematikan internet otomatis saat kuota habis.</div></details>
                                    <details><summary>Apa itu FUP? <img src="assets/img/icon/chevron-down.svg" class="faq-toggle-icon"></summary><div class="faq-answer">Batas pemakaian wajar untuk menjaga kualitas jaringan.</div></details>
                                    <details><summary>Metode pembayaran apa saja? <img src="assets/img/icon/chevron-down.svg" class="faq-toggle-icon"></summary><div class="faq-answer">Transfer Bank, E-Wallet, dan Kartu Kredit/Debit.</div></details>
                                </div>
                            </div>
                        </section>
                    </main>
                    <my-footer></my-footer>
                `;
            }

            async afterRender() {
                // 1. ANIMASI ANGKA STATISTIK
                this.initStatsAnimation();

                // 2. FETCH PRODUK POPULER (Di sini tempat yang benar!)
                //    Karena render() sudah selesai, elemen #popularPackagesContainer sudah ada di DOM.
                await this.fetchPopularProducts();
            }

            // --- LOGIC FETCH PRODUK DIPINDAHKAN KE METHOD CLASS ---
            async fetchPopularProducts() {
                const container = document.getElementById('popularPackagesContainer');
                if (!container) return; // Safety check

                const API_URL = "http://127.0.0.1:8000/api/products"; 

                try {
                    let products = [];
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error("Gagal mengambil data");
                        products = await response.json();
                    } catch (e) {
                        console.warn("Backend FastAPI offline. Menggunakan Mock Data.");
                        // Mock Data Fallback
                        products = [
                            { category: "General Offer", name: "Internet Hemat", price: 80000, data_quota_internet: 30, validity: 30, description: "Cocok untuk penggunaan harian standar." },
                            { category: "Streaming Partner Pack", name: "Movie Mania", price: 110000, data_quota_internet: 50, validity: 30, description: "Nonton sepuasnya tanpa takut kuota habis." },
                            { category: "Gaming & Esports", name: "Pro Gamer", price: 150000, data_quota_internet: 75, validity: 30, description: "Ping rendah dan koneksi stabil untuk gaming." }
                        ];
                    }
                    
                    const popularProducts = products.slice(0, 3); 

                    if (popularProducts.length === 0) {
                        container.innerHTML = '<p>Belum ada produk tersedia.</p>';
                        return;
                    }

                    container.innerHTML = ''; 

                    popularProducts.forEach((p, index) => {
                        const isFeatured = index === 1; 
                        const cardClass = isFeatured ? 'package-card featured' : 'package-card';
                        const badgeText = p.category ? p.category.toUpperCase().split(' ')[0] : 'PAKET';
                        
                        let iconSrc = 'assets/img/icon/solid_signal.svg';
                        if (p.category && p.category.includes('Streaming')) iconSrc = 'assets/img/icon/play-fill.svg';
                        
                        const priceK = (p.price / 1000).toFixed(0) + "k";

                        const html = `
                            <article class="${cardClass}" onclick="window.location.href='product.html'">
                                <div class="card-top">
                                    <div class="card-header">
                                        <span class="badge-outline">${badgeText}</span>
                                        <img src="${iconSrc}" class="${isFeatured ? 'card-icon-filled' : 'card-icon'}" alt="Icon">
                                    </div>
                                    <div class="data-amount ${isFeatured ? 'text-gold' : ''}">
                                        ${p.data_quota_internet || 0} <span class="unit">GB</span>
                                    </div>
                                </div>
                                <div class="card-divider"></div>
                                <ul class="features-list">
                                    <li><img src="assets/img/icon/check-circle.svg" alt="Check"> Masa Aktif ${p.validity} Hari</li>
                                    <li><img src="assets/img/icon/check-circle.svg" alt="Check"> 5G Network Ready</li>
                                    <li><img src="assets/img/icon/check-circle.svg" alt="Check"> ${p.description || "Koneksi Stabil"}</li>
                                </ul>
                                <div class="card-footer">
                                    <div class="price-info">
                                        <span class="label">Mulai dari</span>
                                        <div class="price">Rp ${priceK} <span class="period">/bulan</span></div>
                                    </div>
                                    <button class="btn-circle-arrow ${isFeatured ? 'filled' : ''}">
                                        <img src="assets/img/icon/arrow-up.svg" style="${isFeatured ? 'transform: rotate(45deg);' : ''}" alt="Arrow">
                                    </button>
                                </div>
                            </article>
                        `;
                        container.innerHTML += html;
                    });

                } catch (error) {
                    console.error("Error fetching products:", error);
                    container.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat paket.</p>';
                }
            }

            initStatsAnimation() {
                const statsSection = document.getElementById('statsSection');
                if (statsSection) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const numbers = entry.target.querySelectorAll('.stat-number');
                                numbers.forEach(numElement => {
                                    const originalText = numElement.innerText;
                                    const parts = originalText.match(/(\d+)|(\D+)/g);
                                    if (parts) {
                                        numElement.innerHTML = '';
                                        parts.forEach(part => {
                                            if (/\d+/.test(part)) {
                                                const span = document.createElement('span');
                                                span.innerText = '0';
                                                numElement.appendChild(span);
                                                const targetVal = parseInt(part);
                                                const duration = 2000;
                                                const startTime = performance.now();
                                                const animate = (currentTime) => {
                                                    const elapsedTime = currentTime - startTime;
                                                    const progress = Math.min(elapsedTime / duration, 1);
                                                    const ease = (progress === 1) ? 1 : 1 - Math.pow(2, -10 * progress);
                                                    span.innerText = Math.floor(ease * targetVal);
                                                    if (progress < 1) requestAnimationFrame(animate);
                                                    else span.innerText = targetVal;
                                                };
                                                requestAnimationFrame(animate);
                                            } else {
                                                const span = document.createElement('span');
                                                span.innerText = part;
                                                numElement.appendChild(span);
                                            }
                                        });
                                    }
                                });
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.5 });
                    observer.observe(statsSection);
                }
            }
        }

        // --- SISTEM ROUTING ---
        const routes = {
            '/': Home,
            '': Home,
            '#home': Home,
            '#login': Login,
            '#register': Register
        };

        const router = async () => {
            const contentDiv = document.getElementById('app');
            let hash = location.hash || '#home';
            if (hash === '' || hash === '#') hash = '#home';

            let PageClass = routes[hash] || Home;

            try {
                const page = new PageClass();
                contentDiv.innerHTML = await page.render();
                window.scrollTo(0, 0);
                if (page.afterRender) await page.afterRender();
            } catch (error) {
                console.error("Gagal render:", error);
                contentDiv.innerHTML = '<h1 style="color:white;text-align:center;padding:50px;">404 - Error Render</h1>';
            }
        };

        window.addEventListener('hashchange', router);
        window.addEventListener('DOMContentLoaded', router);
        
        // HAPUS event listener DOMContentLoaded global yang lama agar tidak konflik
        // document.addEventListener('DOMContentLoaded', ...); <--- INI PENYEBAB ERROR SEBELUMNYA
    </script>

</body>
</html>